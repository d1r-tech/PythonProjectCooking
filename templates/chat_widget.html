<div class="chat-widget active" id="chat-widget">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
    <div class="chat-header">
        <div class="chat-title">
            <span class="ai-icon">ü§ñ</span>
            <h3>–ö—É–ª–∏–Ω–∞—Ä–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
        </div>
        <div class="chat-actions">
            <button class="btn-icon close-btn"
                    onclick="document.getElementById('chat-widget-container').innerHTML = ''"
                    title="–ó–∞–∫—Ä—ã—Ç—å">
                ‚úï
            </button>
        </div>
    </div>

    <!-- –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="chat-messages" id="chat-messages">
        <div class="welcome-message">
            <p>–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∫—É–ª–∏–Ω–∞—Ä–∏–∏. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</p>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ —Å —á–∏—Å—Ç—ã–º JavaScript -->
    <div class="chat-input-area">
        <form id="chat-form" onsubmit="sendMessage(event)">
            <div class="input-group">
                <input type="text"
                       name="message"
                       id="message-input"
                       placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –æ —Ä–µ—Ü–µ–ø—Ç–∞—Ö..."
                       required
                       autocomplete="off"
                       class="message-input">
                <button type="submit" class="send-btn">
                    <span class="send-icon">üì§</span>
                </button>
            </div>
            <small class="hint">–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</small>
        </form>
    </div>
</div>
<!-- –î–û–ë–ê–í–¨–¢–ï method="POST" -->
<form method="POST" action="{{ url_for('send_message') }}"
      hx-post="{{ url_for('send_message') }}"
      hx-target="#chat-messages"
      hx-swap="beforeend"
      hx-on::after-request="if(event.detail.successful) this.reset()"
      class="message-form">
<style>
    .chat-widget {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        z-index: 1000;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .chat-header {
        background: linear-gradient(135deg, #f56565 0%, #ed8936 100%);
        color: white;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-title { display: flex; align-items: center; gap: 10px; }
    .ai-icon { font-size: 24px; }

    .chat-title h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }

    .btn-icon {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8fafc;
    }

    .welcome-message {
        background: white;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        text-align: center;
        color: #4b5563;
    }

    .chat-input-area {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
        background: white;
    }

    .input-group { display: flex; gap: 8px; }

    .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 14px;
    }

    .message-input:focus {
        outline: none;
        border-color: #f56565;
    }

    .send-btn {
        background: #f56565;
        color: white;
        border: none;
        width: 48px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<script>
async function sendMessage(event) {
    event.preventDefault(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

    const form = event.target;
    const input = document.getElementById('message-input');
    const messagesDiv = document.getElementById('chat-messages');

    if (!input.value.trim()) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É
    const userMessage = `
    <div class="chat-message user-message">
        <div class="message-avatar">üë§</div>
        <div class="message-content">
            <div class="message-text">${input.value}</div>
        </div>
    </div>`;

    messagesDiv.innerHTML += userMessage;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const formData = new FormData(form);

    try {
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ:', input.value);

        const response = await fetch('/chat/send', {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'text/html',
            }
        });

        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);

        if (response.ok) {
            const html = await response.text();
            console.log('HTML –æ—Ç–≤–µ—Ç:', html);
            messagesDiv.innerHTML += html;
        } else {
            const error = await response.text();
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', error);
            messagesDiv.innerHTML += `
            <div class="chat-message ai-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-text">–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ${response.status}</div>
                </div>
            </div>`;
        }
    } catch (error) {
        console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:', error);
        messagesDiv.innerHTML += `
        <div class="chat-message ai-message">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                <div class="message-text">–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}</div>
            </div>
        </div>`;
    }

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –∏ –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    form.reset();
}

// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('message-input');
    if (input) {
        setTimeout(() => input.focus(), 100);
    }
});
</script>
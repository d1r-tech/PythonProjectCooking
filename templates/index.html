{% extends "base.html" %}

{% block content %}
    <!-- ============ –ë–õ–û–ö –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ü–û–ò–°–ö–ï ============ -->
    {% if search_query %}
    <div class="alert alert-info mb-4" style="
        background: rgba(212, 165, 116, 0.1);
        border: 1px solid rgba(212, 165, 116, 0.3);
        border-radius: 12px;
        color: #333;
    ">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-2" style="color: #D4A574;">
                    <i class="fas fa-search mr-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                </h5>
                <p class="mb-1">
                    –ü–æ –∑–∞–ø—Ä–æ—Å—É <strong>"{{ search_query }}"</strong>
                    –Ω–∞–π–¥–µ–Ω–æ <strong class="text-primary">{{ recipes|length }}</strong> —Ä–µ—Ü–µ–ø—Ç–æ–≤
                </p>
                {% if no_allergens_filter and current_user.is_authenticated %}
                <small class="text-muted">
                    <i class="fas fa-filter mr-1"></i>
                    –§–∏–ª—å—Ç—Ä: "–ë–µ–∑ –º–æ–∏—Ö –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤" –∞–∫—Ç–∏–≤–µ–Ω
                </small>
                {% endif %}
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-sm" style="
                    background: #D4A574;
                    color: white;
                    border-radius: 20px;
                    border: 1px solid rgba(212, 165, 116, 0.3);
                    padding: 6px 15px;
                ">
                    <i class="fas fa-times mr-1"></i> –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫
                </a>
            </div>
        </div>

        <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ (—Å–∫—Ä—ã—Ç—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div class="mt-3">
            <button class="btn btn-link btn-sm p-0" type="button"
                    data-toggle="collapse" data-target="#advancedSearch"
                    aria-expanded="false" aria-controls="advancedSearch"
                    style="color: #D4A574; text-decoration: none;">
                <i class="fas fa-sliders-h mr-1"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
            </button>

            <div class="collapse mt-2" id="advancedSearch">
                <form method="GET" action="{{ url_for('search') }}" class="border-top pt-3">
                    <input type="hidden" name="q" value="{{ search_query }}">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="searchCategory" class="small text-muted mb-1">
                                    <i class="fas fa-filter"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏—è:
                                </label>
                                <select name="category" id="searchCategory" class="form-control form-control-sm">
                                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>
                                        {{ cat }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        {% if current_user.is_authenticated %}
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" name="no_allergens"
                                       id="noAllergens" value="true"
                                       {% if no_allergens_filter %}checked{% endif %}>
                                <label class="form-check-label small" for="noAllergens">
                                    <i class="fas fa-allergies"></i> –ë–µ–∑ –º–æ–∏—Ö –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤
                                </label>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <button type="submit" class="btn btn-sm" style="
                        background: #D4A574;
                        color: white;
                        border-radius: 20px;
                        padding: 5px 20px;
                    ">
                        <i class="fas fa-search mr-1"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- ============ –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ü–û–ò–°–ö–ê ============ -->
{% if selected_category %}
<div style="
    margin-bottom: 25px;
    padding: 15px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
">
    <a href="/" style="
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background-color: #FFF8F0;
        border-radius: 12px;
        border: 1px solid rgba(212, 165, 116, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    ">
        <span style="
            color: #333;
            font-size: 0.95rem;
            font-weight: 600 !important;
            margin-left: 5px;
        ">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
    </a>
</div>

<style>
a[href="/"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: rgba(212, 165, 116, 0.5);
}
</style>

<style>
@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
{% endif %}

<style>
.category-buttons {
    display: flex;
    gap: 25px;
    flex-wrap: wrap;
    margin: 40px 0;
    justify-content: center;
}
</style>
{% if selected_category %}
<div class="allergen-filter mb-4">
    <label class="form-label">–ò—Å–∫–ª—é—á–∏—Ç—å –∞–ª–ª–µ—Ä–≥–µ–Ω—ã:</label>

    <div class="btn-group dropright">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            –í—ã–±–µ—Ä–∏—Ç–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã
        </button>
        <div class="dropdown-menu p-3" style="
            width: 600px !important;
            max-width: 90vw !important;
            border: 2px solid rgba(212, 165, 116, 0.3) !important;
            box-shadow: 0 6px 25px rgba(212, 165, 116, 0.1) !important;
        ">
            <div style="
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                grid-gap: 15px 25px !important;
                max-height: 350px !important;
                overflow-y: auto !important;
                padding-right: 10px !important;
                padding-bottom: 10px !important;
            ">
                {% for allergen in all_allergens|sort(attribute='title') %}
                <div style="
                    display: flex !important;
                    align-items: center !important;
                    min-height: 30px !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                ">
                    <input class="allergen-checkbox"
                           type="checkbox"
                           value="{{ allergen.id }}"
                           id="allergen{{ allergen.id }}"
                           style="
                               margin-right: 10px !important;
                               margin-top: 0 !important;
                               flex-shrink: 0 !important;
                               width: 20px !important;
                               height: 20px !important;
                           ">
                    <label for="allergen{{ allergen.id }}"
                           style="
                               cursor: pointer !important;
                               margin: 0 !important;
                               padding: 0 !important;
                               line-height: 1.3 !important;
                               display: block !important;
                               width: 100% !important;
                               white-space: nowrap !important;
                               overflow: hidden !important;
                               text-overflow: ellipsis !important;
                           ">
                        {{ allergen.title }}
                    </label>
                </div>
                {% endfor %}
            </div>

            <div class="mt-3 pt-2 border-top text-center" style="margin-top: 15px !important; padding-top: 15px !important;">
                <button class="btn btn-info btn-sm px-4" onclick="applyFilter()" style="margin-right: 10px !important;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="btn btn-outline-secondary btn-sm px-4" onclick="clearFilter()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="selectedAllergens" class="mt-2"></div>
</div>
{% endif %}

{% if not selected_category %}
<h2 class="main-content-spacing">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª —Ä–µ—Ü–µ–ø—Ç–æ–≤:</h2>
<div style="margin: 40px 0;">
    <div style="display: flex; flex-wrap: wrap; gap: 25px; justify-content: center;">
        <a href="/?category=–ó–∞–≤—Ç—Ä–∞–∫–∏"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/breakfast.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–ó–∞–≤—Ç—Ä–∞–∫–∏</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>

        <a href="/?category=–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/hotdishes.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>

        <a href="/?category=–î–µ—Å–µ—Ä—Ç—ã"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/desserts.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–î–µ—Å–µ—Ä—Ç—ã</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>

        <a href="/?category=–°—É–ø—ã"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/soup.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–°—É–ø—ã</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>

        <a href="/?category=–ù–∞–ø–∏—Ç–∫–∏"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/drinks.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–ù–∞–ø–∏—Ç–∫–∏</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>
    </div>
</div>

{% else %}
<div class="recipes-section">
    <h3>{{ selected_category }}</h3>
    <div id="recipesList">
        {% if recipes %}
            {% for recipe in recipes %}
            <div class="recipe-card card mb-3" data-allergens="{{ recipe.allergens|map(attribute='id')|join(',') }}">
                <div class="card-body">
                    <h4 class="card-title">{{ recipe.title }}</h4>
                    <p class="card-text"><strong>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</strong> {{ recipe.ingredients }}</p>
                    <p class="card-text"><strong>–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</strong><br>{{ recipe.content | replace('\n', '<br>') | safe }}</p>
                    <p class="card-text"><strong>–ê–ª–ª–µ—Ä–≥–µ–Ω—ã:</strong>
                        {{ recipe.allergens|map(attribute='title')|join(', ') or '–Ω–µ—Ç' }}
                    </p>
                    <div class="recipe-actions">
                        <a href="/download_recipe/{{ recipe.id }}"
                           class="recipe-action-btn btn-download">
                           –°–∫–∞—á–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç
                        </a>

                        {% if current_user.is_authenticated %}
                            <a href="/add_to_favourites/{{ recipe.id }}"
                                class="recipe-action-btn btn-add-fav">
                                –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                            </a>
                        {% else %}
                            <button class="recipe-action-btn btn-disabled"
                                onclick="showRegistrationAlert()"
                                title="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                    –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ü–µ–ø—Ç–æ–≤</p>
        {% endif %}
    </div>

    <div class="mt-3">
        <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–∞–∑–¥–µ–ª–∞–º</a>
    </div>
</div>
{% endif %}
<script>
let selectedAllergens = [];

function applyFilter() {
    selectedAllergens = Array.from(document.querySelectorAll('.allergen-checkbox:checked'))
        .map(checkbox => checkbox.value);

    updateSelectedAllergensDisplay();

    filterRecipes();

    $('.dropdown-menu').removeClass('show');
}

function clearFilter() {
    document.querySelectorAll('.allergen-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    selectedAllergens = [];
    updateSelectedAllergensDisplay();
    filterRecipes();

    $('.dropdown-menu').removeClass('show');
}

function updateSelectedAllergensDisplay() {
    const container = document.getElementById('selectedAllergens');
    if (selectedAllergens.length > 0) {
        container.innerHTML = '<strong>–ò—Å–∫–ª—é—á–µ–Ω—ã:</strong> ' + selectedAllergens.map(id => {
            const checkbox = document.querySelector(`.allergen-checkbox[value="${id}"]`);
            return checkbox ? checkbox.nextElementSibling.textContent : '';
        }).filter(name => name).join(', ');
    } else {
        container.innerHTML = '';
    }
}

function filterRecipes() {
    const recipeCards = document.querySelectorAll('.recipe-card');

    recipeCards.forEach(card => {
        const recipeAllergens = card.getAttribute('data-allergens').split(',').filter(id => id !== '');
        const hasSelectedAllergen = selectedAllergens.some(allergen => recipeAllergens.includes(allergen));

        card.style.display = hasSelectedAllergen ? 'none' : 'block';
    });
}
</script>
<div id="registrationAlert" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 10000;">
    <div style="
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-size: 15px;
        font-weight: 500;
        animation: fadeSlide 4s ease-in-out;
        transition: opacity 0.8s ease;
    ">
        üìù <strong>–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</strong>
    </div>
</div>

<script>
function showRegistrationAlert() {
    const alert = document.getElementById('registrationAlert');
    alert.style.display = 'block';

    // –ß–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã –ø–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º
    setTimeout(() => {
        alert.style.opacity = '0';
        setTimeout(() => {
            alert.style.display = 'none';
            alert.style.opacity = '1';
        }, 800);
    }, 3200);
}

</script>

<style>
@keyframes fadeSlide {
    0% {
        opacity: 0;
        transform: translateX(30px);
    }
    20% {
        opacity: 1;
        transform: translateX(0);
    }
    80% {
        opacity: 1;
        transform: translateX(0);
    }
    100% {
        opacity: 0;
        transform: translateX(30px);
    }
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<!-- ‚≠ê‚≠ê‚≠ê –ö–û–ú–ü–ê–ö–¢–ù–´–ô –õ–û–ì–û–¢–ò–ü –í –£–ì–õ–£ (–¢–û–õ–¨–ö–û –í –†–ê–ó–î–ï–õ–ê–•) ‚≠ê‚≠ê‚≠ê -->
{% if selected_category %}
<div style="
    margin-bottom: 25px;
    padding: 15px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
">
    <a href="/" style="
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background-color: #FFF8F0;
        border-radius: 12px;
        border: 1px solid rgba(212, 165, 116, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    ">
        <span style="
            color: #333;
            font-size: 0.95rem;
            font-weight: 600 !important;
            margin-left: 5px;
        ">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
    </a>
</div>

<style>
a[href="/"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: rgba(212, 165, 116, 0.5);
}
</style>

<style>
@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
{% endif %}


<!-- ‚≠ê‚≠ê‚≠ê –í–ê–® –°–¢–ê–†–´–ô –ö–û–î –ù–ò–ñ–ï (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ‚≠ê‚≠ê‚≠ê -->
<style>
.category-buttons {
    display: flex;
    gap: 25px;
    flex-wrap: wrap;
    margin: 40px 0;
    justify-content: center;
}
</style>
<!-- –§–ò–õ–¨–¢–† –ü–û –ê–õ–õ–ï–†–ì–ï–ù–ê–ú -->
{% if selected_category %}
<div class="allergen-filter mb-4">
    <label class="form-label">–ò—Å–∫–ª—é—á–∏—Ç—å –∞–ª–ª–µ—Ä–≥–µ–Ω—ã:</label>

    <div class="btn-group dropright">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            –í—ã–±–µ—Ä–∏—Ç–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã
        </button>
        <div class="dropdown-menu p-3" style="
            width: 600px !important;
            max-width: 90vw !important;
            border: 2px solid rgba(212, 165, 116, 0.3) !important;
            box-shadow: 0 6px 25px rgba(212, 165, 116, 0.1) !important;
        ">
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ß–ï–¢–ö–ò–ú–ò —Å—Ç–∏–ª—è–º–∏ -->
            <div style="
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                grid-gap: 15px 25px !important;
                max-height: 350px !important;
                overflow-y: auto !important;
                padding-right: 10px !important;
                padding-bottom: 10px !important;
            ">
                <!-- ‚≠ê –°–û–†–¢–ò–†–û–í–ö–ê –ü–û –ê–õ–§–ê–í–ò–¢–£ ‚≠ê -->
                {% for allergen in all_allergens|sort(attribute='title') %}
                <div style="
                    display: flex !important;
                    align-items: center !important;
                    min-height: 30px !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                ">
                    <input class="allergen-checkbox"
                           type="checkbox"
                           value="{{ allergen.id }}"
                           id="allergen{{ allergen.id }}"
                           style="
                               margin-right: 10px !important;
                               margin-top: 0 !important;
                               flex-shrink: 0 !important;
                               width: 20px !important;
                               height: 20px !important;
                           ">
                    <label for="allergen{{ allergen.id }}"
                           style="
                               cursor: pointer !important;
                               margin: 0 !important;
                               padding: 0 !important;
                               line-height: 1.3 !important;
                               display: block !important;
                               width: 100% !important;
                               white-space: nowrap !important;
                               overflow: hidden !important;
                               text-overflow: ellipsis !important;
                           ">
                        {{ allergen.title }}
                    </label>
                </div>
                {% endfor %}
            </div>

            <div class="mt-3 pt-2 border-top text-center" style="margin-top: 15px !important; padding-top: 15px !important;">
                <button class="btn btn-info btn-sm px-4" onclick="applyFilter()" style="margin-right: 10px !important;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button class="btn btn-outline-secondary btn-sm px-4" onclick="clearFilter()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="selectedAllergens" class="mt-2"></div>
</div>
{% endif %}

{% if not selected_category %}
<!-- –ë–õ–û–ö –í–´–ë–û–†–ê –†–ê–ó–î–ï–õ–û–í -->
<h2 class="main-content-spacing">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª —Ä–µ—Ü–µ–ø—Ç–æ–≤:</h2>
<div style="margin: 40px 0;">
    <div style="display: flex; flex-wrap: wrap; gap: 25px; justify-content: center;">
        <!-- 1. –ó–∞–≤—Ç—Ä–∞–∫–∏ -->
        <a href="/?category=–ó–∞–≤—Ç—Ä–∞–∫–∏"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/breakfast.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–ó–∞–≤—Ç—Ä–∞–∫–∏</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>

        <!-- 2. –û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞ -->
        <a href="/?category=–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/hotdishes.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>

        <!-- 3. –î–µ—Å–µ—Ä—Ç—ã -->
        <a href="/?category=–î–µ—Å–µ—Ä—Ç—ã"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/desserts.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–î–µ—Å–µ—Ä—Ç—ã</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>

        <!-- 4. –°—É–ø—ã -->
        <a href="/?category=–°—É–ø—ã"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/soup.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–°—É–ø—ã</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>

        <!-- 5. –ù–∞–ø–∏—Ç–∫–∏ -->
        <a href="/?category=–ù–∞–ø–∏—Ç–∫–∏"
           style="display: block !important; width: 300px !important; height: 150px !important;
                  background: url('/static/images/drinks.jpg') center/cover no-repeat !important;
                  color: white !important; text-decoration: none !important; border-radius: 12px !important;
                  font-size: 18px !important; text-align: center !important; line-height: 150px !important;
                  text-shadow: 1px 1px 2px black !important; border: 2px solid rgba(255, 255, 255, 0.8) !important;
                  font-weight: bold !important; box-shadow: 0 8px 25px rgba(0, 150, 255, 0.3) !important;
                  position: relative !important; overflow: hidden !important;">
            <span style="position: relative; z-index: 2;">–ù–∞–ø–∏—Ç–∫–∏</span>
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 42, 0.4); z-index: 1;"></div>
        </a>
    </div>
</div>

{% else %}
<!-- –ë–õ–û–ö –†–ï–¶–ï–ü–¢–û–í -->
<div class="recipes-section">
    <h3>{{ selected_category }}</h3>
    <div id="recipesList">
        {% if recipes %}
            {% for recipe in recipes %}
            <div class="recipe-card card mb-3" data-allergens="{{ recipe.allergens|map(attribute='id')|join(',') }}">
                <div class="card-body">
                    <h4 class="card-title">{{ recipe.title }}</h4>
                    <p class="card-text"><strong>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</strong> {{ recipe.ingredients }}</p>
                    <p class="card-text"><strong>–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</strong><br>{{ recipe.content | replace('\n', '<br>') | safe }}</p>
                    <p class="card-text"><strong>–ê–ª–ª–µ—Ä–≥–µ–Ω—ã:</strong>
                        {{ recipe.allergens|map(attribute='title')|join(', ') or '–Ω–µ—Ç' }}
                    </p>
                    <div class="favourite-section">
                        {% if current_user.is_authenticated %}
                            <a href="/add_to_favourites/{{ recipe.id }}" class="btn btn-outline-success btn-sm">
                                ‚òÜ –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                            </a>
                        {% else %}
                            <button class="btn btn-outline-secondary btn-sm"
                                onclick="showRegistrationAlert()"
                                title="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                    ‚òÜ –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ü–µ–ø—Ç–æ–≤</p>
        {% endif %}
    </div>

    <div class="mt-3">
        <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–∞–∑–¥–µ–ª–∞–º</a>
    </div>
</div>
{% endif %}
<!-- JavaScript –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
<script>
let selectedAllergens = [];

function applyFilter() {
    // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã
    selectedAllergens = Array.from(document.querySelectorAll('.allergen-checkbox:checked'))
        .map(checkbox => checkbox.value);

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤
    updateSelectedAllergensDisplay();

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
    filterRecipes();

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown
    $('.dropdown-menu').removeClass('show');
}

function clearFilter() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã
    document.querySelectorAll('.allergen-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
    selectedAllergens = [];
    updateSelectedAllergensDisplay();
    filterRecipes();

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown
    $('.dropdown-menu').removeClass('show');
}

function updateSelectedAllergensDisplay() {
    const container = document.getElementById('selectedAllergens');
    if (selectedAllergens.length > 0) {
        container.innerHTML = '<strong>–ò—Å–∫–ª—é—á–µ–Ω—ã:</strong> ' + selectedAllergens.map(id => {
            const checkbox = document.querySelector(`.allergen-checkbox[value="${id}"]`);
            return checkbox ? checkbox.nextElementSibling.textContent : '';
        }).filter(name => name).join(', ');
    } else {
        container.innerHTML = '';
    }
}

function filterRecipes() {
    const recipeCards = document.querySelectorAll('.recipe-card');

    recipeCards.forEach(card => {
        const recipeAllergens = card.getAttribute('data-allergens').split(',').filter(id => id !== '');
        const hasSelectedAllergen = selectedAllergens.some(allergen => recipeAllergens.includes(allergen));

        card.style.display = hasSelectedAllergen ? 'none' : 'block';
    });
}
</script>
<!-- –ü–æ–ª–æ—Å–∫–∞-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É -->
<div id="registrationAlert" style="display: none; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;">
    <div style="background: #e8e8e8; color: #333; padding: 15px 20px; border-bottom: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 16px; font-weight: 500;">
                üìù <strong>–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</strong>
            </div>
            <button onclick="hideRegistrationAlert()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">
                √ó
            </button>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
function showRegistrationAlert() {
    const alertDiv = document.getElementById('registrationAlert');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    alertDiv.style.display = 'block';

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        hideRegistrationAlert();
    }, 4000);
}

function hideRegistrationAlert() {
    document.getElementById('registrationAlert').style.display = 'none';
}
</script>
<style>
#registrationAlert {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
/* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
#registrationAlert::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3);
    z-index: -1;
    display: none;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<style>
.category-buttons {
    display: flex;
    gap: 25px;
    flex-wrap: wrap;
    margin: 20px 0;
}

.btn-primary {
    padding: 12px 24px;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-size: 16px;
    display: inline-block;
    text-align: center;
    min-width: 300px;
    min-height: 100px;
    background-size: cover;
    background-position: center;
    text-shadow: 1px 1px 2px black;
    border: 2px solid white;
    font-weight: bold;
}

.btn-primary[href*="Завтраки"] { background-image: url('/static/images/breakfast.jpg'); }
.btn-primary[href*="Основные блюда"] { background-image: url('/static/images/hotdishes.jpg'); }
.btn-primary[href*="Десерты"] { background-image: url('/static/images/desserts.jpg'); }
.btn-primary[href*="Супы"] { background-image: url('/static/images/soup.jpg'); }
</style>

<!-- ФИЛЬТР ПО АЛЛЕРГЕНАМ -->
{% if selected_category %}
<div class="allergen-filter mb-4">
    <label class="form-label">Исключить аллергены:</label>

    <div class="btn-group dropright">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            Выберите аллергены
        </button>
        <div class="dropdown-menu" style="padding: 10px; width: 300px;">
            {% for allergen in all_allergens %}
            <div class="form-check">
                <input class="form-check-input allergen-checkbox" type="checkbox" value="{{ allergen.id }}" id="allergen{{ allergen.id }}">
                <label class="form-check-label" for="allergen{{ allergen.id }}">
                    {{ allergen.title }}
                </label>
            </div>
            {% endfor %}
            <div class="mt-2">
                <button class="btn btn-info" onclick="applyFilter()">Применить</button>
                <button class="btn btn-secondary" onclick="clearFilter()">Сбросить</button>
            </div>
        </div>
    </div>

    <div id="selectedAllergens" class="mt-2"></div>
</div>
{% endif %}

{% if not selected_category %}
<!-- БЛОК ВЫБОРА РАЗДЕЛОВ -->
<h2>Выберите раздел рецептов:</h2>
<div class="categories mb-4">
    <div class="category-buttons">
        {% for category in categories %}
            <a href="/?category={{ category }}" class="btn btn-primary">
                {{ category }}
            </a>
        {% endfor %}
    </div>
</div>
{% else %}
<!-- БЛОК РЕЦЕПТОВ -->
<div class="recipes-section">
    <h3>"{{ selected_category }}"</h3>

    <div id="recipesList">
        {% if recipes %}
            {% for recipe in recipes %}
            <div class="recipe-card card mb-3" data-allergens="{{ recipe.allergens|map(attribute='id')|join(',') }}">
                <div class="card-body">
                    <h4 class="card-title">{{ recipe.title }}</h4>
                    <p class="card-text"><strong>Ингредиенты:</strong> {{ recipe.ingredients }}</p>
                    <p class="card-text"><strong>Приготовление:</strong><br>{{ recipe.content | replace('\n', '<br>') | safe }}</p>
                    <p class="card-text"><strong>Аллергены:</strong>
                        {{ recipe.allergens|map(attribute='title')|join(', ') or 'нет' }}
                    </p>
                    <div class="favourite-section">
                        {% if current_user.is_authenticated %}
                            {% if recipe in current_user.favourite_recipes %}
                                <a href="/remove_from_favourites/{{ recipe.id }}" class="btn btn-success btn-sm">
                                    ★ В избранном
                                </a>
                            {% else %}
                                <a href="/add_to_favourites/{{ recipe.id }}" class="btn btn-outline-success btn-sm">
                                    ☆ Добавить в избранное
                                </a>
                            {% endif %}
                        {% else %}
                            <button class="btn btn-outline-secondary btn-sm" title="Зарегистрируйтесь, чтобы добавить рецепт в избранное">
                                ☆ Добавить в избранное
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>В этом разделе пока нет рецептов</p>
        {% endif %}
    </div>

    <div class="mt-3">
        <a href="/" class="btn btn-secondary">← Назад к разделам</a>
    </div>
</div>

<!-- JavaScript для фильтрации -->
<script>
let selectedAllergens = [];

function applyFilter() {
    // Собираем выбранные аллергены
    selectedAllergens = Array.from(document.querySelectorAll('.allergen-checkbox:checked'))
        .map(checkbox => checkbox.value);

    // Обновляем отображение выбранных аллергенов
    updateSelectedAllergensDisplay();

    // Применяем фильтр
    filterRecipes();

    // Закрываем dropdown
    $('.dropdown-menu').removeClass('show');
}

function clearFilter() {
    // Сбрасываем чекбоксы
    document.querySelectorAll('.allergen-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });

    // Сбрасываем фильтр
    selectedAllergens = [];
    updateSelectedAllergensDisplay();
    filterRecipes();

    // Закрываем dropdown
    $('.dropdown-menu').removeClass('show');
}

function updateSelectedAllergensDisplay() {
    const container = document.getElementById('selectedAllergens');
    if (selectedAllergens.length > 0) {
        container.innerHTML = '<strong>Исключены:</strong> ' + selectedAllergens.map(id => {
            const checkbox = document.querySelector(`.allergen-checkbox[value="${id}"]`);
            return checkbox ? checkbox.nextElementSibling.textContent : '';
        }).filter(name => name).join(', ');
    } else {
        container.innerHTML = '';
    }
}

function filterRecipes() {
    const recipeCards = document.querySelectorAll('.recipe-card');

    recipeCards.forEach(card => {
        const recipeAllergens = card.getAttribute('data-allergens').split(',').filter(id => id !== '');
        const hasSelectedAllergen = selectedAllergens.some(allergen => recipeAllergens.includes(allergen));

        card.style.display = hasSelectedAllergen ? 'none' : 'block';
    });
}
</script>
{% endif %}
{% endblock %}
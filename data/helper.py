"""
–ü–û–ú–û–©–ù–ò–ö –ü–û –ó–ê–ú–ï–ù–ï –ò–ù–ì–†–ï–î–ò–ï–ù–¢–û–í –î–õ–Ø –ê–õ–õ–ï–†–ì–ò–ö–û–í
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∞—à—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏ –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤
"""

import random
from flask import session
from flask_login import current_user
from data import db_session
from data.recipes import Recipes
from data.allergens import Allergen


class IngredientReplacer:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–º–µ–Ω–æ–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""

    def __init__(self):
        self.replacements_db = self._load_replacements()
        self.category_tips = self._load_category_tips()

    def _load_replacements(self):
        """–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –æ –∑–∞–º–µ–Ω–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤"""
        return {
            # –ê–ª–ª–µ—Ä–≥–µ–Ω—ã –∏–∑ –≤–∞—à–µ–≥–æ default_allergens.py
            "–º–æ–ª–æ–∫–æ": {
                "–¥–ª—è_–≤—ã–ø–µ—á–∫–∏": ["—Å–æ–µ–≤–æ–µ –º–æ–ª–æ–∫–æ", "–º–∏–Ω–¥–∞–ª—å–Ω–æ–µ –º–æ–ª–æ–∫–æ", "–æ–≤—Å—è–Ω–æ–µ –º–æ–ª–æ–∫–æ", "–≤–æ–¥–∞"],
                "–¥–ª—è_—Å—É–ø–æ–≤": ["–æ–≤–æ—â–Ω–æ–π –±—É–ª—å–æ–Ω", "–∫–æ–∫–æ—Å–æ–≤–æ–µ –º–æ–ª–æ–∫–æ", "–≤–æ–¥–∞ —Å –æ–ª–∏–≤–∫–æ–≤—ã–º –º–∞—Å–ª–æ–º"],
                "–¥–ª—è_—Å–æ—É—Å–æ–≤": ["—Å–º–µ—Ç–∞–Ω–∞ –Ω–∞ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å–Ω–æ–≤–µ", "–∫–æ–∫–æ—Å–æ–≤—ã–µ —Å–ª–∏–≤–∫–∏", "–æ–≤–æ—â–Ω–æ–π –ø—é—Ä–µ"],
                "—Å–æ–≤–µ—Ç": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ —Ç–æ–º –∂–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ, —á—Ç–æ –∏ –º–æ–ª–æ–∫–æ. –î–ª—è –≤—ã–ø–µ—á–∫–∏ –ª—É—á—à–µ —Å–æ–µ–≤–æ–µ –º–æ–ª–æ–∫–æ."
            },

            "—è–π—Ü–∞": {
                "–¥–ª—è_–≤—ã–ø–µ—á–∫–∏": ["–±–∞–Ω–∞–Ω–æ–≤–æ–µ –ø—é—Ä–µ (1/2 –±–∞–Ω–∞–Ω–∞ = 1 —è–π—Ü–æ)", "—è–±–ª–æ—á–Ω–æ–µ –ø—é—Ä–µ (1/4 —á–∞—à–∫–∏)",
                                "—Å–µ–º–µ–Ω–∞ –ª—å–Ω–∞ (1 —Å—Ç.–ª. + 3 —Å—Ç.–ª. –≤–æ–¥—ã)", "–∞–∫–≤–∞—Ñ–∞–±–∞ (3 —Å—Ç.–ª. = 1 —è–π—Ü–æ)"],
                "–¥–ª—è_—Å–≤—è–∑—ã–≤–∞–Ω–∏—è": ["–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª", "–∫—É–∫—É—Ä—É–∑–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª", "–Ω—É—Ç–æ–≤–∞—è –º—É–∫–∞"],
                "–¥–ª—è_–æ–º–ª–µ—Ç–∞": ["—Ç–æ—Ñ—É (–≤–∑–±–∏—Ç—ã–π)", "–Ω—É—Ç–æ–≤–∞—è –º—É–∫–∞ + –≤–æ–¥–∞", "–æ–≤—Å—è–Ω—ã–µ —Ö–ª–æ–ø—å—è + –≤–æ–¥–∞"],
                "—Å–æ–≤–µ—Ç": "–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –±–ª—é–¥–∞ –Ω—É–∂–µ–Ω —Å–≤–æ–π –∑–∞–º–µ–Ω–∏—Ç–µ–ª—å. –í –≤—ã–ø–µ—á–∫–µ —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–∞–Ω–∞–Ω–æ–≤–æ–µ –ø—é—Ä–µ."
            },

            "–ø—à–µ–Ω–∏—Ü–∞": {
                "–º—É–∫–∞": ["–≥—Ä–µ—á–Ω–µ–≤–∞—è –º—É–∫–∞", "—Ä–∏—Å–æ–≤—É—é –º—É–∫—É", "–∫—É–∫—É—Ä—É–∑–Ω—É—é –º—É–∫—É", "–Ω—É—Ç–æ–≤–∞—è –º—É–∫–∞"],
                "–º–∞–∫–∞—Ä–æ–Ω—ã": ["–≥—Ä–µ—á–Ω–µ–≤—ã–µ –º–∞–∫–∞—Ä–æ–Ω—ã", "—Ä–∏—Å–æ–≤—ã–µ –º–∞–∫–∞—Ä–æ–Ω—ã", "–∫—É–∫—É—Ä—É–∑–Ω—ã–µ –º–∞–∫–∞—Ä–æ–Ω—ã"],
                "—Ö–ª–µ–±": ["–±–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤—ã–π —Ö–ª–µ–±", "—Ä–∏—Å–æ–≤—ã–µ –ª–µ–ø–µ—à–∫–∏", "–∫—É–∫—É—Ä—É–∑–Ω—ã–µ –ª–µ–ø–µ—à–∫–∏"],
                "—Å–æ–≤–µ—Ç": "–°–º–µ—à–∏–≤–∞–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –≤–∏–¥—ã –º—É–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∏—Å–æ–≤–∞—è + –∫—É–∫—É—Ä—É–∑–Ω–∞—è)."
            },

            "–≥–ª—é—Ç–µ–Ω": {
                "–≤_–≤—ã–ø–µ—á–∫–µ": ["–±–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤—ã–µ —Å–º–µ—Å–∏", "—Ä–∏—Å–æ–≤–∞—è –º—É–∫–∞", "–∫—É–∫—É—Ä—É–∑–Ω–∞—è –º—É–∫–∞", "–≥—Ä–µ—á–Ω–µ–≤–∞—è –º—É–∫–∞"],
                "–≤_–ª–∞–ø—à–µ": ["—Ä–∏—Å–æ–≤–∞—è –ª–∞–ø—à–∞", "–≥—Ä–µ—á–Ω–µ–≤–∞—è –ª–∞–ø—à–∞", "–∫—É–∫—É—Ä—É–∑–Ω–∞—è –ª–∞–ø—à–∞"],
                "–≤_—Å–æ—É—Å–∞—Ö": ["–∫—É–∫—É—Ä—É–∑–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª", "–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª"],
                "—Å–æ–≤–µ—Ç": "–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ—Å—Ç–∞–≤—ã - –≥–ª—é—Ç–µ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Å–æ—É—Å–∞—Ö, –ø—Ä–∏–ø—Ä–∞–≤–∞—Ö –∏ –ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç–∞—Ö."
            },

            # –î–æ–±–∞–≤–ª—è–µ–º –¥—Ä—É–≥–∏–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞
            "–æ—Ä–µ—Ö–∏": {
                "–º–∏–Ω–¥–∞–ª—å": ["—Å–µ–º–µ–Ω–∞ –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫–∞", "—Ç—ã–∫–≤–µ–Ω–Ω—ã–µ —Å–µ–º–µ—á–∫–∏", "–∫—É–Ω–∂—É—Ç"],
                "–≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö": ["—Å–µ–º–µ–Ω–∞ –ª—å–Ω–∞", "—Å–µ–º–µ–Ω–∞ —á–∏–∞", "–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω—ã–µ —Å–µ–º–µ—á–∫–∏"],
                "–∞—Ä–∞—Ö–∏—Å": ["—Å–µ–º–µ–Ω–∞ –ø–æ–¥—Å–æ–ª–Ω—É—Ö–∞", "—Ç—ã–∫–≤–µ–Ω–Ω—ã–µ —Å–µ–º–µ—á–∫–∏", "–Ω—É—Ç"],
                "—Ñ–∏—Å—Ç–∞—à–∫–∞": ["–∫–µ–¥—Ä–æ–≤—ã–µ –æ—Ä–µ—à–∫–∏", "—Å–µ–º–µ–Ω–∞ –∫—É–Ω–∂—É—Ç–∞"],
                "–∫–µ—à—å—é": ["–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω—ã–µ —Å–µ–º–µ—á–∫–∏", "—Ç—ã–∫–≤–µ–Ω–Ω—ã–µ —Å–µ–º–µ—á–∫–∏"],
                "—Å–æ–≤–µ—Ç": "–û–±–∂–∞—Ä–∏–≤–∞–π—Ç–µ —Å–µ–º–µ—á–∫–∏ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è –æ—Ä–µ—Ö–æ–≤–æ–≥–æ –≤–∫—É—Å–∞."
            },

            "—Ä—ã–±–∞": {
                "—Ç—Ä–µ—Å–∫–∞": ["—Ç–æ—Ñ—É", "–Ω—É—Ç", "–±–µ–ª–∞—è —Ñ–∞—Å–æ–ª—å", "–∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ"],
                "–ª–æ—Å–æ—Å—å": ["–∞–≤–æ–∫–∞–¥–æ", "—Ç–æ—Ñ—É —Å –≤–æ–¥–æ—Ä–æ—Å–ª—è–º–∏", "–≥—Ä–∏–±—ã"],
                "–±–µ–ª–∞—è —Ä—ã–±–∞": ["—Ç–æ—Ñ—É", "–±–æ–±—ã", "—á–µ—á–µ–≤–∏—Ü–∞", "–∫—É—Ä–∏—Ü–∞"],
                "—Å–æ–≤–µ—Ç": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ—Ä—Å–∫—É—é —Å–æ–ª—å –∏–ª–∏ –Ω–æ—Ä–∏ –¥–ª—è —Ä—ã–±–Ω–æ–≥–æ –≤–∫—É—Å–∞."
            },

            "–º–µ–¥": {
                "–≤_–≤—ã–ø–µ—á–∫–µ": ["–∫–ª–µ–Ω–æ–≤—ã–π —Å–∏—Ä–æ–ø", "—Å–∏—Ä–æ–ø –∞–≥–∞–≤—ã", "–ø–∞—Ç–æ–∫–∞", "—Ñ–∏–Ω–∏–∫–æ–≤—ã–π —Å–∏—Ä–æ–ø"],
                "–≤_–Ω–∞–ø–∏—Ç–∫–∞—Ö": ["—Å—Ç–µ–≤–∏—è", "—ç—Ä–∏—Ç—Ä–∏—Ç", "—Å–∏—Ä–æ–ø —Ç–æ–ø–∏–Ω–∞–º–±—É—Ä–∞"],
                "–≤_—Å–æ—É—Å–∞—Ö": ["—Ñ—Ä—É–∫—Ç–æ–≤–æ–µ –ø—é—Ä–µ", "—è–±–ª–æ—á–Ω—ã–π —Å–æ—É—Å"],
                "—Å–æ–≤–µ—Ç": "–ó–∞–º–µ–Ω—è–π—Ç–µ –≤ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ 1:1. –°–∏—Ä–æ–ø –∞–≥–∞–≤—ã –º–µ–Ω–µ–µ —Å–ª–∞–¥–∫–∏–π."
            },

            "—Å–æ—è": {
                "—Å–æ–µ–≤—ã–π_—Å–æ—É—Å": ["–∫–æ–∫–æ—Å–æ–≤—ã–µ –∞–º–∏–Ω–æ–∫–∏—Å–ª–æ—Ç—ã", "–∂–∏–¥–∫–∏–π –∞–º–∏–Ω", "—Å–æ–ª—å + –Ω–µ–º–Ω–æ–≥–æ —É–∫—Å—É—Å–∞"],
                "—Ç–æ—Ñ—É": ["–Ω—É—Ç", "—Ñ–∞—Å–æ–ª—å", "—á–µ—á–µ–≤–∏—Ü–∞", "—è–π—Ü–∞ (–µ—Å–ª–∏ –Ω–µ—Ç –∞–ª–ª–µ—Ä–≥–∏–∏)"],
                "—Å–æ–µ–≤–æ–µ_–º–æ–ª–æ–∫–æ": ["–æ–≤—Å—è–Ω–æ–µ –º–æ–ª–æ–∫–æ", "–º–∏–Ω–¥–∞–ª—å–Ω–æ–µ –º–æ–ª–æ–∫–æ", "—Ä–∏—Å–æ–≤–æ–µ –º–æ–ª–æ–∫–æ"],
                "—Å–æ–≤–µ—Ç": "–°–æ—è —á–∞—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç–∞—Ö –∏ —Å–æ—É—Å–∞—Ö."
            }
        }

    def _load_category_tips(self):
        """–°–æ–≤–µ—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –±–ª—é–¥ –∏–∑ –≤–∞—à–µ–π –±–∞–∑—ã"""
        return {
            "—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–ª–∞–Ω–µ—Ç—ã ü™ê": "–í –∑–∞–≤—Ç—Ä–∞–∫–∞—Ö –≤–∞–∂–Ω–∞ —Ç–µ–∫—Å—Ç—É—Ä–∞. –î–ª—è –æ–º–ª–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ñ—É, –¥–ª—è –≤—ã–ø–µ—á–∫–∏ - –±–∞–Ω–∞–Ω–æ–≤–æ–µ –ø—é—Ä–µ.",
            "–≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—É–ø—ã ü•£": "–í —Å—É–ø–∞—Ö –∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–∞—Ä–∫—É. –¢–æ—Ñ—É –∏ –≥—Ä–∏–±—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç.",
            "—Å–ª–∞–¥–∫–∏–µ —Å–æ–∑–≤–µ–∑–¥–∏—è ‚ú®": "–í –¥–µ—Å–µ—Ä—Ç–∞—Ö –≤–∞–∂–Ω–∞ —Å–ª–∞–¥–æ—Å—Ç—å –∏ —Ç–µ–∫—Å—Ç—É—Ä–∞. –ö–ª–µ–Ω–æ–≤—ã–π —Å–∏—Ä–æ–ø —Ö–æ—Ä–æ—à–æ –∑–∞–º–µ–Ω—è–µ—Ç –º–µ–¥.",
            "–≥–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏ üöÄ": "–í –Ω–∞–ø–∏—Ç–∫–∞—Ö –∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã —Ö–æ—Ä–æ—à–æ —Å–º–µ—à–∏–≤–∞—Ç—å—Å—è.",
            "–æ—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞ üçõ": "–í –æ—Å–Ω–æ–≤–Ω—ã—Ö –±–ª—é–¥–∞—Ö –∑–∞–º–µ–Ω—è–π—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ø–æ —Ç–µ–∫—Å—Ç—É—Ä–µ.",
            "—Å—É–ø—ã": "–î–ª—è —Å—É–ø–æ–≤ –≤—ã–±–∏—Ä–∞–π—Ç–µ –∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–∞–∑–≤–∞—Ä—è—Ç—Å—è –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞—Ä–∫–µ.",
            "–¥–µ—Å–µ—Ä—Ç—ã": "–í –¥–µ—Å–µ—Ä—Ç–∞—Ö –∑–∞–º–µ–Ω–∏—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –¥–µ—Ä–∂–∞—Ç—å —Ñ–æ—Ä–º—É –∏ –Ω–µ —Ä–∞—Å—Å–ª–∞–∏–≤–∞—Ç—å—Å—è.",
            "–Ω–∞–ø–∏—Ç–∫–∏": "–î–ª—è –Ω–∞–ø–∏—Ç–∫–æ–≤ –≤–∞–∂–Ω–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—Å–∞–¥–∫–∞."
        }

    def find_recipes_without_allergen(self, allergen_name):
        """–ù–∞—Ö–æ–¥–∏—Ç —Ä–µ—Ü–µ–ø—Ç—ã –ë–ï–ó —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∞–ª–ª–µ—Ä–≥–µ–Ω–∞"""
        try:
            db_sess = db_session.create_session()

            # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã
            all_recipes = db_sess.query(Recipes).all()
            safe_recipes = []

            for recipe in all_recipes:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω –≤ —ç—Ç–æ–º —Ä–µ—Ü–µ–ø—Ç–µ
                has_allergen = False
                for allergen in recipe.allergens:
                    if allergen.title.lower() == allergen_name.lower():
                        has_allergen = True
                        break

                # –ï—Å–ª–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω–∞ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ü–µ–ø—Ç
                if not has_allergen:
                    safe_recipes.append({
                        "title": recipe.title,
                        "category": recipe.category,
                        "ingredients": recipe.ingredients[:100] + "..." if len(
                            recipe.ingredients) > 100 else recipe.ingredients
                    })

            db_sess.close()
            return safe_recipes[:5]  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 —Ä–µ—Ü–µ–ø—Ç–æ–≤

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ä–µ—Ü–µ–ø—Ç–æ–≤: {e}")
            return []

    def get_available_allergens(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            db_sess = db_session.create_session()
            allergens = db_sess.query(Allergen).all()
            allergen_names = [a.title for a in allergens]
            db_sess.close()
            return allergen_names
        except:
            # Fallback –µ—Å–ª–∏ –±–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
            return ["–ú–æ–ª–æ–∫–æ", "–Ø–π—Ü–∞", "–ü—à–µ–Ω–∏—Ü–∞", "–°–æ—è", "–ì–ª—é—Ç–µ–Ω", "–†—ã–±–∞", "–û—Ä–µ—Ö–∏", "–ú–µ–¥"]

    def format_recipe_list(self, recipes):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç"""
        if not recipes:
            return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –±–µ–∑ —ç—Ç–æ–≥–æ –∞–ª–ª–µ—Ä–≥–µ–Ω–∞."

        response = "üçΩÔ∏è **–†–µ—Ü–µ–ø—Ç—ã –±–µ–∑ —ç—Ç–æ–≥–æ –∞–ª–ª–µ—Ä–≥–µ–Ω–∞:**\n\n"
        for i, recipe in enumerate(recipes, 1):
            response += f"{i}. **{recipe['title']}**\n"
            response += f"   üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {recipe['category']}\n"
            response += f"   üõí –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã: {recipe['ingredients']}\n\n"

        response += "‚úÖ –≠—Ç–∏ —Ä–µ—Ü–µ–ø—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è –≤–∞—Å!"
        return response

    def find_replacement(self, ingredient, category=None):
        """–ù–∞—Ö–æ–¥–∏—Ç –∑–∞–º–µ–Ω—É –¥–ª—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞"""
        ingredient_lower = ingredient.lower()

        # –ò—â–µ–º –≤ –±–∞–∑–µ –∑–∞–º–µ–Ω
        for key, replacements in self.replacements_db.items():
            if key in ingredient_lower:
                # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                category_key = category.lower() if category else "–¥–ª—è_–≤—ã–ø–µ—á–∫–∏"

                # –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                replacement_list = []
                tip = ""

                for cat_key, repl_list in replacements.items():
                    if cat_key != "—Å–æ–≤–µ—Ç":
                        if category and category_key in cat_key:
                            replacement_list = repl_list
                            tip = replacements.get("—Å–æ–≤–µ—Ç", "")
                            break

                # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
                if not replacement_list:
                    for cat_key, repl_list in replacements.items():
                        if cat_key != "—Å–æ–≤–µ—Ç":
                            replacement_list = repl_list
                            tip = replacements.get("—Å–æ–≤–µ—Ç", "")
                            break

                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                if replacement_list:
                    replacements_text = "\n".join([f"‚Ä¢ {repl}" for repl in replacement_list])

                    response = f"""üîÑ **–ó–∞–º–µ–Ω–∞ {ingredient}**{' –≤ ' + category if category else ''}:

{replacements_text}

üí° **–°–æ–≤–µ—Ç:** {tip}"""

                    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–≤–µ—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                    if category and category.lower() in self.category_tips:
                        response += f"\n\nüìù **–î–ª—è {category.lower()}:** {self.category_tips[category.lower()]}"

                    # –î–æ–±–∞–≤–ª—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã
                    safe_recipes = self.find_recipes_without_allergen(ingredient)
                    if safe_recipes:
                        response += "\n\n" + self.format_recipe_list(safe_recipes)

                    return response

        # –ï—Å–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
        return self._general_response(ingredient)

    def _general_response(self, query):
        """–û–±—â–∏–µ –æ—Ç–≤–µ—Ç—ã"""
        query_lower = query.lower()

        # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        if any(word in query_lower for word in ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–¥–æ–±—Ä—ã–π", "hello", "hi"]):
            return """üëã **–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∑–∞–º–µ–Ω–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–ª–ª–µ—Ä–≥–∏–∫–æ–≤.**

–Ø –º–æ–≥—É:
‚Ä¢ üîÑ –ü–æ–¥—Å–∫–∞–∑–∞—Ç—å —á–µ–º –∑–∞–º–µ–Ω–∏—Ç—å –∞–ª–ª–µ—Ä–≥–µ–Ω –≤ –±–ª—é–¥–µ
‚Ä¢ üçΩÔ∏è –ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç—ã –±–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∞–ª–ª–µ—Ä–≥–µ–Ω–∞
‚Ä¢ üìö –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞—Ö

**–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ "–ß–µ–º –∑–∞–º–µ–Ω–∏—Ç—å –º–æ–ª–æ–∫–æ –≤ –≤—ã–ø–µ—á–∫–µ?"
‚Ä¢ "–ß—Ç–æ –≤–º–µ—Å—Ç–æ —è–∏—Ü –≤ –æ–º–ª–µ—Ç–µ?"
‚Ä¢ "–†–µ—Ü–µ–ø—Ç—ã –±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞"
‚Ä¢ "–ö–∞–∫–∏–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã –µ—Å—Ç—å –≤ –±–∞–∑–µ?"""

        # –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
        if "—Å–ø–∞—Å–∏–±–æ" in query_lower:
            return "üòä **–ü–æ–∂–∞–ª—É–π—Å—Ç–∞!** –í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å —Å–¥–µ–ª–∞—Ç—å –≤–∞—à–µ –ø–∏—Ç–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∏ –≤–∫—É—Å–Ω—ã–º!"

        # –°–ø–∏—Å–æ–∫ –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤
        if any(word in query_lower for word in ["–∞–ª–ª–µ—Ä–≥–µ–Ω", "—Å–ø–∏—Å–æ–∫", "–∫–∞–∫–∏–µ –µ—Å—Ç—å"]):
            allergens = self.get_available_allergens()
            allergens_list = "\n".join([f"‚Ä¢ {a}" for a in allergens[:15]])
            more = f"\n\n...–∏ –µ—â–µ {len(allergens) - 15} –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤" if len(allergens) > 15 else ""
            return f"""üìã **–ê–ª–ª–µ—Ä–≥–µ–Ω—ã –≤ –Ω–∞—à–µ–π –±–∞–∑–µ:**

{allergens_list}{more}

**–°–ø—Ä–æ—Å–∏—Ç–µ:** "–ß–µ–º –∑–∞–º–µ–Ω–∏—Ç—å [–∞–ª–ª–µ—Ä–≥–µ–Ω] –≤ [–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥–∞]?"""

        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥
        if "–∫–∞—Ç–µ–≥–æ—Ä–∏" in query_lower or "—Ç–∏–ø" in query_lower:
            categories = list(self.category_tips.keys())
            categories_list = "\n".join([f"‚Ä¢ {cat}" for cat in categories])
            return f"""üìÅ **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥:**

{categories_list}

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:** "–ß–µ–º –∑–∞–º–µ–Ω–∏—Ç—å –º–æ–ª–æ–∫–æ –≤ —Å—É–ø–∞—Ö?"""

        # –ü–æ–º–æ—â—å
        if any(word in query_lower for word in ["–ø–æ–º–æ—â—å", "help", "–∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è"]):
            return """üÜò **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ–º–æ—â–Ω–∏–∫–æ–º:**

1. **–ó–∞–º–µ–Ω–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:**
   ‚Ä¢ "–ß–µ–º –∑–∞–º–µ–Ω–∏—Ç—å –º–æ–ª–æ–∫–æ –≤ –≤—ã–ø–µ—á–∫–µ?"
   ‚Ä¢ "–ß—Ç–æ –≤–º–µ—Å—Ç–æ —è–∏—Ü –≤ —Å–∞–ª–∞—Ç–µ?"

2. **–ü–æ–∏—Å–∫ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤:**
   ‚Ä¢ "–†–µ—Ü–µ–ø—Ç—ã –±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞"
   ‚Ä¢ "–ë–ª—é–¥–∞ –±–µ–∑ –æ—Ä–µ—Ö–æ–≤"

3. **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
   ‚Ä¢ "–ö–∞–∫–∏–µ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã –µ—Å—Ç—å?"
   ‚Ä¢ "–ö–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–ª—é–¥?"

4. **–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:**
   ‚Ä¢ "–ü—Ä–∏–≤–µ—Ç"
   ‚Ä¢ "–°–ø–∞—Å–∏–±–æ"

**–ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ!**"""

        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ
        available_allergens = self.get_available_allergens()[:8]
        allergens_str = ", ".join(available_allergens)

        return f"""ü§î **–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å:** "{query}"

**–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å –∑–∞–º–µ–Ω–æ–π:**
{allergens_str}...

**–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–∞–∫:**
‚Ä¢ "–ß–µ–º –∑–∞–º–µ–Ω–∏—Ç—å –º–æ–ª–æ–∫–æ –≤ –≤—ã–ø–µ—á–∫–µ?"
‚Ä¢ "–ß—Ç–æ –≤–º–µ—Å—Ç–æ —è–∏—Ü?"
‚Ä¢ "–†–µ—Ü–µ–ø—Ç—ã –±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞"

–ò–ª–∏ —Å–∫–∞–∂–∏—Ç–µ "–ø–æ–º–æ—â—å" –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."""


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–æ–º–æ—â–Ω–∏–∫–∞
helper = IngredientReplacer()


# ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø FLASK ==========
def send_to_ai(message, user_id):
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        response = helper.find_replacement(message)
        if not response:
            response = helper._general_response(message)
        return response, True
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ –ø–æ–º–æ—â–Ω–∏–∫–µ: {e}")
        return "üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ-–¥—Ä—É–≥–æ–º—É.", False


def get_user_id():
    """–ü–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if current_user.is_authenticated:
        return f"user_{current_user.id}"

    if 'anon_chat_id' not in session:
        import uuid
        session['anon_chat_id'] = str(uuid.uuid4())

    return f"anon_{session['anon_chat_id']}"


def clear_chat_history(user_id):
    """–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞)"""
    pass


def get_chat_history(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞)"""
    return []